# 📁 照片上傳功能 - 程式碼檔案清單

## 🎯 功能概述
此文檔列出所有與照片上傳功能相關的程式碼檔案，包括前端、後端、配置和測試檔案。

---

## 📂 前端檔案 (Frontend)

### 🖥️ 主要組件檔案

#### `/frontend/src/views/ChatView.vue`
**功能**：聊天界面主組件，包含照片上傳功能
- 📸 照片上傳按鈕和檔案選擇器
- 🖼️ 圖片預覽和移除功能
- 📱 響應式設計和拖放支援
- ⚠️ 檔案格式和大小驗證
- 🎨 CSS 樣式定義

**關鍵程式碼片段**：
```vue
<!-- 照片上傳按鈕 -->
<el-button type="info" :icon="Picture" @click="openFileSelector">
  上傳照片
</el-button>

<!-- 圖片預覽區域 -->
<div v-if="selectedImage" class="image-preview">
  <img :src="selectedImage.url" alt="預覽圖片" />
</div>
```

**相關方法**：
- `openFileSelector()` - 開啟檔案選擇器
- `handleImageSelect()` - 處理檔案選擇
- `removeSelectedImage()` - 移除選中圖片
- `handleSendMessage()` - 發送包含圖片的訊息

---

### 🗃️ 狀態管理檔案

#### `/frontend/src/stores/chat.js`
**功能**：聊天狀態管理，處理訊息和圖片資料
- 💾 聊天記錄管理
- 🖼️ 圖片資料處理
- 📡 API 呼叫邏輯
- ❌ 錯誤狀態處理

**關鍵程式碼片段**：
```javascript
async function sendMessage(apiKey, userMessage, earNumContext, imageData = null) {
  const userMessageObj = { 
    role: 'user', 
    content: userMessage || (imageData ? '請幫我分析這張山羊照片' : '')
  };
  
  if (imageData) {
    userMessageObj.image = {
      url: imageData.url,
      name: imageData.name,
      type: imageData.type
    };
  }
  
  await api.chatWithAgent(apiKey, userMessage, sessionId.value, earNumContext, imageData);
}
```

---

### 🌐 API 層檔案

#### `/frontend/src/api/index.js`
**功能**：HTTP 請求處理，支援 FormData 上傳
- 📡 RESTful API 呼叫
- 📤 FormData 多媒體上傳
- 🔄 請求/回應攔截器
- ⚡ 錯誤處理機制

**關鍵程式碼片段**：
```javascript
chatWithAgent(apiKey, message, sessionId, earNumContext, imageData = null) {
  if (imageData && imageData.file) {
    const formData = new FormData();
    formData.append('api_key', apiKey);
    formData.append('message', message);
    formData.append('session_id', sessionId);
    formData.append('image', imageData.file);
    
    return apiClient.post('/api/agent/chat', formData, {
      headers: { 'Content-Type': 'multipart/form-data' }
    });
  } else {
    const payload = { api_key: apiKey, message, session_id: sessionId };
    return apiClient.post('/api/agent/chat', payload);
  }
}
```

---

## 🔧 後端檔案 (Backend)

### 🛣️ API 路由檔案

#### `/backend/app/api/agent.py`
**功能**：主要 API 端點，處理聊天和圖片分析
- 🔐 使用者認證和授權
- 📁 檔案上傳處理和驗證
- 🔢 Base64 編碼轉換
- 🤖 Gemini Vision API 整合
- 💾 聊天記錄儲存

**關鍵程式碼片段**：
```python
@bp.route('/chat', methods=['POST'])
@login_required
def chat_with_agent():
    """與 AI 聊天，支援文字和圖片"""
    if 'image' in request.files:
        image_file = request.files['image']
        
        # 檔案驗證
        allowed_types = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp']
        if image_file.content_type not in allowed_types:
            return jsonify(error="不支援的圖片格式"), 400
        
        # 大小檢查
        image_data = image_file.read()
        if len(image_data) > 10 * 1024 * 1024:
            return jsonify(error="圖片檔案不能超過 10MB"), 400
        
        # Base64 編碼
        image_base64 = base64.b64encode(image_data).decode('utf-8')
        
        # 準備 Gemini API 請求
        user_message_parts = [{"text": user_message}]
        user_message_parts.append({
            "inline_data": {
                "mime_type": image_file.content_type,
                "data": image_base64
            }
        })
```

**主要方法**：
- `chat_with_agent()` - 主要聊天 API 端點
- 檔案驗證和處理邏輯
- Gemini API 呼叫整合
- 聊天記錄儲存

---

### 🔧 工具函數檔案

#### `/backend/app/utils.py`
**功能**：通用工具函數，包含 API 呼叫和圖片處理
- 🤖 Gemini API 呼叫封裝
- 🔢 Base64 編碼工具
- 🐑 羊隻資料查詢
- ⚙️ 配置參數處理

**關鍵程式碼片段**：
```python
def call_gemini_api(prompt_text, api_key, generation_config_override=None):
    """通用 Gemini API 調用函數，支援文字和圖片"""
    payload_contents = []
    if isinstance(prompt_text, str):
        payload_contents.append({"role": "user", "parts": [{"text": prompt_text}]})
    elif isinstance(prompt_text, list):
        payload_contents = prompt_text
    
    payload = {
        "contents": payload_contents,
        "generationConfig": generation_config,
        "safetySettings": safety_settings
    }
    
    response = requests.post(GEMINI_API_URL, headers=headers, data=json.dumps(payload))
    return response.json()

def encode_image_to_base64(image_data):
    """將圖片數據編碼為 base64 字符串"""
    return base64.b64encode(image_data).decode('utf-8')
```

---

### 🗃️ 資料模型檔案

#### `/backend/app/models.py`
**功能**：資料庫模型定義
- 👤 使用者模型
- 💬 聊天記錄模型
- 🐑 羊隻資料模型
- 🔗 關聯關係定義

**相關模型**：
```python
class ChatHistory(db.Model):
    """聊天記錄模型，支援圖片標記"""
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)
    session_id = db.Column(db.String(100), nullable=False)
    role = db.Column(db.String(20), nullable=False)  # 'user' 或 'model'
    content = db.Column(db.Text, nullable=False)     # 包含 "[包含圖片]" 標記
    ear_num_context = db.Column(db.String(50))
    timestamp = db.Column(db.DateTime, default=datetime.utcnow)
```

---

### ✅ 資料驗證檔案

#### `/backend/app/schemas.py`
**功能**：請求資料驗證和序列化
- 📋 Pydantic 模型定義
- ✅ 輸入資料驗證
- 🔄 資料轉換和清理
- ❌ 錯誤訊息格式化

**相關模型**：
```python
class AgentChatModel(BaseModel):
    """聊天請求資料模型"""
    api_key: str
    message: str
    session_id: str
    ear_num_context: Optional[str] = None
    
    class Config:
        str_strip_whitespace = True
        min_anystr_length = 1
```

---

## ⚙️ 配置檔案

### 📦 前端配置

#### `/frontend/package.json`
**功能**：前端依賴管理和腳本定義
```json
{
  "dependencies": {
    "vue": "^3.4.0",
    "element-plus": "^2.4.0",
    "@element-plus/icons-vue": "^2.3.0",
    "pinia": "^2.1.0",
    "axios": "^1.6.0"
  }
}
```

#### `/frontend/vite.config.js`
**功能**：前端建構配置
```javascript
export default defineConfig({
  plugins: [vue()],
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:5000',
        changeOrigin: true
      }
    }
  }
});
```

### 🐍 後端配置

#### `/backend/requirements.txt`
**功能**：Python 依賴列表
```
Flask==2.3.3
Flask-Login==0.6.3
Flask-SQLAlchemy==3.0.5
Pydantic==2.4.2
requests==2.31.0
markdown==3.5.1
```

#### `/backend/.env`
**功能**：環境變數配置
```bash
GOOGLE_API_KEY=your_gemini_api_key_here
MAX_CONTENT_LENGTH=10485760  # 10MB
SECRET_KEY=your_secret_key_here
```

---

## 🧪 測試檔案

### 🔍 單元測試

#### `/test_image_upload.py`
**功能**：基本功能測試
```python
def test_base64_encoding():
    """測試圖片 base64 編碼功能"""
    fake_image_data = b'\x89PNG\r\n\x1a\n...'
    encoded = base64.b64encode(fake_image_data).decode('utf-8')
    decoded = base64.b64decode(encoded)
    assert fake_image_data == decoded
```

#### `/frontend/src/stores/chat.test.js`
**功能**：前端狀態管理測試
```javascript
describe('Chat Store - Image Upload', () => {
  test('should handle image data correctly', () => {
    const imageData = {
      file: new File(['test'], 'test.jpg', { type: 'image/jpeg' }),
      url: 'data:image/jpeg;base64,...',
      name: 'test.jpg'
    };
    expect(sendMessage('api_key', 'message', null, imageData)).toBeDefined();
  });
});
```

---

## 📚 文檔檔案

### 📖 使用指南

#### `/docs/照片上傳功能指南.md`
**功能**：完整的使用者指南和技術說明
- 🎯 功能概述和特色
- 📱 詳細使用步驟
- 🛠️ 技術實作說明
- 🐛 故障排除指南
- 📊 效能最佳化建議

#### `/docs/照片上傳功能技術文檔.md`
**功能**：開發者技術文檔
- 🏗️ 系統架構圖
- 🔄 資料流程說明
- 💻 程式碼範例
- 🧪 測試策略
- 🚀 部署指南

---

## 🔧 部署相關檔案

### 🐳 容器化配置

#### `/backend/Dockerfile`
**功能**：後端 Docker 配置
```dockerfile
FROM python:3.9-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY . .
CMD ["python", "run.py"]
```

#### `/frontend/Dockerfile`
**功能**：前端 Docker 配置
```dockerfile
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build
```

#### `/docker-compose.yml`
**功能**：整體服務編排
```yaml
services:
  backend:
    build: ./backend
    environment:
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
  frontend:
    build: ./frontend
    ports:
      - "3000:80"
```

---

## 📊 檔案統計摘要

### 🎯 功能分佈
- **前端檔案**: 3 個主要檔案
- **後端檔案**: 4 個主要檔案
- **配置檔案**: 6 個配置檔案
- **測試檔案**: 2 個測試檔案
- **文檔檔案**: 3 個說明文檔
- **部署檔案**: 3 個部署配置

### 📈 程式碼規模
- **前端程式碼**: ~500 行 (Vue + JavaScript)
- **後端程式碼**: ~300 行 (Python + Flask)
- **測試程式碼**: ~100 行
- **文檔內容**: ~2000 行

### 🔧 技術棧
- **前端**: Vue.js 3, Element Plus, Pinia, Vite
- **後端**: Flask, SQLAlchemy, Pydantic
- **API**: Google Gemini Vision API
- **資料庫**: SQLite (開發), PostgreSQL (生產)
- **部署**: Docker, Docker Compose

---

## 🚀 快速定位指南

### 🐛 除錯時查看的檔案
1. `/frontend/src/views/ChatView.vue` - 前端 UI 問題
2. `/backend/app/api/agent.py` - 後端 API 問題
3. `/frontend/src/api/index.js` - 網路請求問題
4. `/backend/app/utils.py` - Gemini API 呼叫問題

### 🔧 功能擴展時修改的檔案
1. `/frontend/src/stores/chat.js` - 狀態管理擴展
2. `/backend/app/schemas.py` - 資料驗證擴展
3. `/backend/app/models.py` - 資料庫模型擴展
4. `/docs/` - 文檔更新

### 📦 部署時需要的檔案
1. `/docker-compose.yml` - 服務編排
2. `/backend/Dockerfile` - 後端容器
3. `/frontend/Dockerfile` - 前端容器
4. `/.env` - 環境變數配置

---

*檔案清單版本：v1.0.0*  
*最後更新：2025年8月1日*
