# ğŸ“ ç…§ç‰‡ä¸Šå‚³åŠŸèƒ½ - ç¨‹å¼ç¢¼æª”æ¡ˆæ¸…å–®

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°
æ­¤æ–‡æª”åˆ—å‡ºæ‰€æœ‰èˆ‡ç…§ç‰‡ä¸Šå‚³åŠŸèƒ½ç›¸é—œçš„ç¨‹å¼ç¢¼æª”æ¡ˆï¼ŒåŒ…æ‹¬å‰ç«¯ã€å¾Œç«¯ã€é…ç½®å’Œæ¸¬è©¦æª”æ¡ˆã€‚

---

## ğŸ“‚ å‰ç«¯æª”æ¡ˆ (Frontend)

### ğŸ–¥ï¸ ä¸»è¦çµ„ä»¶æª”æ¡ˆ

#### `/frontend/src/views/ChatView.vue`
**åŠŸèƒ½**ï¼šèŠå¤©ç•Œé¢ä¸»çµ„ä»¶ï¼ŒåŒ…å«ç…§ç‰‡ä¸Šå‚³åŠŸèƒ½
- ğŸ“¸ ç…§ç‰‡ä¸Šå‚³æŒ‰éˆ•å’Œæª”æ¡ˆé¸æ“‡å™¨
- ğŸ–¼ï¸ åœ–ç‰‡é è¦½å’Œç§»é™¤åŠŸèƒ½
- ğŸ“± éŸ¿æ‡‰å¼è¨­è¨ˆå’Œæ‹–æ”¾æ”¯æ´
- âš ï¸ æª”æ¡ˆæ ¼å¼å’Œå¤§å°é©—è­‰
- ğŸ¨ CSS æ¨£å¼å®šç¾©

**é—œéµç¨‹å¼ç¢¼ç‰‡æ®µ**ï¼š
```vue
<!-- ç…§ç‰‡ä¸Šå‚³æŒ‰éˆ• -->
<el-button type="info" :icon="Picture" @click="openFileSelector">
  ä¸Šå‚³ç…§ç‰‡
</el-button>

<!-- åœ–ç‰‡é è¦½å€åŸŸ -->
<div v-if="selectedImage" class="image-preview">
  <img :src="selectedImage.url" alt="é è¦½åœ–ç‰‡" />
</div>
```

**ç›¸é—œæ–¹æ³•**ï¼š
- `openFileSelector()` - é–‹å•Ÿæª”æ¡ˆé¸æ“‡å™¨
- `handleImageSelect()` - è™•ç†æª”æ¡ˆé¸æ“‡
- `removeSelectedImage()` - ç§»é™¤é¸ä¸­åœ–ç‰‡
- `handleSendMessage()` - ç™¼é€åŒ…å«åœ–ç‰‡çš„è¨Šæ¯

---

### ğŸ—ƒï¸ ç‹€æ…‹ç®¡ç†æª”æ¡ˆ

#### `/frontend/src/stores/chat.js`
**åŠŸèƒ½**ï¼šèŠå¤©ç‹€æ…‹ç®¡ç†ï¼Œè™•ç†è¨Šæ¯å’Œåœ–ç‰‡è³‡æ–™
- ğŸ’¾ èŠå¤©è¨˜éŒ„ç®¡ç†
- ğŸ–¼ï¸ åœ–ç‰‡è³‡æ–™è™•ç†
- ğŸ“¡ API å‘¼å«é‚è¼¯
- âŒ éŒ¯èª¤ç‹€æ…‹è™•ç†

**é—œéµç¨‹å¼ç¢¼ç‰‡æ®µ**ï¼š
```javascript
async function sendMessage(apiKey, userMessage, earNumContext, imageData = null) {
  const userMessageObj = { 
    role: 'user', 
    content: userMessage || (imageData ? 'è«‹å¹«æˆ‘åˆ†æé€™å¼µå±±ç¾Šç…§ç‰‡' : '')
  };
  
  if (imageData) {
    userMessageObj.image = {
      url: imageData.url,
      name: imageData.name,
      type: imageData.type
    };
  }
  
  await api.chatWithAgent(apiKey, userMessage, sessionId.value, earNumContext, imageData);
}
```

---

### ğŸŒ API å±¤æª”æ¡ˆ

#### `/frontend/src/api/index.js`
**åŠŸèƒ½**ï¼šHTTP è«‹æ±‚è™•ç†ï¼Œæ”¯æ´ FormData ä¸Šå‚³
- ğŸ“¡ RESTful API å‘¼å«
- ğŸ“¤ FormData å¤šåª’é«”ä¸Šå‚³
- ğŸ”„ è«‹æ±‚/å›æ‡‰æ””æˆªå™¨
- âš¡ éŒ¯èª¤è™•ç†æ©Ÿåˆ¶

**é—œéµç¨‹å¼ç¢¼ç‰‡æ®µ**ï¼š
```javascript
chatWithAgent(apiKey, message, sessionId, earNumContext, imageData = null) {
  if (imageData && imageData.file) {
    const formData = new FormData();
    formData.append('api_key', apiKey);
    formData.append('message', message);
    formData.append('session_id', sessionId);
    formData.append('image', imageData.file);
    
    return apiClient.post('/api/agent/chat', formData, {
      headers: { 'Content-Type': 'multipart/form-data' }
    });
  } else {
    const payload = { api_key: apiKey, message, session_id: sessionId };
    return apiClient.post('/api/agent/chat', payload);
  }
}
```

---

## ğŸ”§ å¾Œç«¯æª”æ¡ˆ (Backend)

### ğŸ›£ï¸ API è·¯ç”±æª”æ¡ˆ

#### `/backend/app/api/agent.py`
**åŠŸèƒ½**ï¼šä¸»è¦ API ç«¯é»ï¼Œè™•ç†èŠå¤©å’Œåœ–ç‰‡åˆ†æ
- ğŸ” ä½¿ç”¨è€…èªè­‰å’Œæˆæ¬Š
- ğŸ“ æª”æ¡ˆä¸Šå‚³è™•ç†å’Œé©—è­‰
- ğŸ”¢ Base64 ç·¨ç¢¼è½‰æ›
- ğŸ¤– Gemini Vision API æ•´åˆ
- ğŸ’¾ èŠå¤©è¨˜éŒ„å„²å­˜

**é—œéµç¨‹å¼ç¢¼ç‰‡æ®µ**ï¼š
```python
@bp.route('/chat', methods=['POST'])
@login_required
def chat_with_agent():
    """èˆ‡ AI èŠå¤©ï¼Œæ”¯æ´æ–‡å­—å’Œåœ–ç‰‡"""
    if 'image' in request.files:
        image_file = request.files['image']
        
        # æª”æ¡ˆé©—è­‰
        allowed_types = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp']
        if image_file.content_type not in allowed_types:
            return jsonify(error="ä¸æ”¯æ´çš„åœ–ç‰‡æ ¼å¼"), 400
        
        # å¤§å°æª¢æŸ¥
        image_data = image_file.read()
        if len(image_data) > 10 * 1024 * 1024:
            return jsonify(error="åœ–ç‰‡æª”æ¡ˆä¸èƒ½è¶…é 10MB"), 400
        
        # Base64 ç·¨ç¢¼
        image_base64 = base64.b64encode(image_data).decode('utf-8')
        
        # æº–å‚™ Gemini API è«‹æ±‚
        user_message_parts = [{"text": user_message}]
        user_message_parts.append({
            "inline_data": {
                "mime_type": image_file.content_type,
                "data": image_base64
            }
        })
```

**ä¸»è¦æ–¹æ³•**ï¼š
- `chat_with_agent()` - ä¸»è¦èŠå¤© API ç«¯é»
- æª”æ¡ˆé©—è­‰å’Œè™•ç†é‚è¼¯
- Gemini API å‘¼å«æ•´åˆ
- èŠå¤©è¨˜éŒ„å„²å­˜

---

### ğŸ”§ å·¥å…·å‡½æ•¸æª”æ¡ˆ

#### `/backend/app/utils.py`
**åŠŸèƒ½**ï¼šé€šç”¨å·¥å…·å‡½æ•¸ï¼ŒåŒ…å« API å‘¼å«å’Œåœ–ç‰‡è™•ç†
- ğŸ¤– Gemini API å‘¼å«å°è£
- ğŸ”¢ Base64 ç·¨ç¢¼å·¥å…·
- ğŸ‘ ç¾Šéš»è³‡æ–™æŸ¥è©¢
- âš™ï¸ é…ç½®åƒæ•¸è™•ç†

**é—œéµç¨‹å¼ç¢¼ç‰‡æ®µ**ï¼š
```python
def call_gemini_api(prompt_text, api_key, generation_config_override=None):
    """é€šç”¨ Gemini API èª¿ç”¨å‡½æ•¸ï¼Œæ”¯æ´æ–‡å­—å’Œåœ–ç‰‡"""
    payload_contents = []
    if isinstance(prompt_text, str):
        payload_contents.append({"role": "user", "parts": [{"text": prompt_text}]})
    elif isinstance(prompt_text, list):
        payload_contents = prompt_text
    
    payload = {
        "contents": payload_contents,
        "generationConfig": generation_config,
        "safetySettings": safety_settings
    }
    
    response = requests.post(GEMINI_API_URL, headers=headers, data=json.dumps(payload))
    return response.json()

def encode_image_to_base64(image_data):
    """å°‡åœ–ç‰‡æ•¸æ“šç·¨ç¢¼ç‚º base64 å­—ç¬¦ä¸²"""
    return base64.b64encode(image_data).decode('utf-8')
```

---

### ğŸ—ƒï¸ è³‡æ–™æ¨¡å‹æª”æ¡ˆ

#### `/backend/app/models.py`
**åŠŸèƒ½**ï¼šè³‡æ–™åº«æ¨¡å‹å®šç¾©
- ğŸ‘¤ ä½¿ç”¨è€…æ¨¡å‹
- ğŸ’¬ èŠå¤©è¨˜éŒ„æ¨¡å‹
- ğŸ‘ ç¾Šéš»è³‡æ–™æ¨¡å‹
- ğŸ”— é—œè¯é—œä¿‚å®šç¾©

**ç›¸é—œæ¨¡å‹**ï¼š
```python
class ChatHistory(db.Model):
    """èŠå¤©è¨˜éŒ„æ¨¡å‹ï¼Œæ”¯æ´åœ–ç‰‡æ¨™è¨˜"""
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)
    session_id = db.Column(db.String(100), nullable=False)
    role = db.Column(db.String(20), nullable=False)  # 'user' æˆ– 'model'
    content = db.Column(db.Text, nullable=False)     # åŒ…å« "[åŒ…å«åœ–ç‰‡]" æ¨™è¨˜
    ear_num_context = db.Column(db.String(50))
    timestamp = db.Column(db.DateTime, default=datetime.utcnow)
```

---

### âœ… è³‡æ–™é©—è­‰æª”æ¡ˆ

#### `/backend/app/schemas.py`
**åŠŸèƒ½**ï¼šè«‹æ±‚è³‡æ–™é©—è­‰å’Œåºåˆ—åŒ–
- ğŸ“‹ Pydantic æ¨¡å‹å®šç¾©
- âœ… è¼¸å…¥è³‡æ–™é©—è­‰
- ğŸ”„ è³‡æ–™è½‰æ›å’Œæ¸…ç†
- âŒ éŒ¯èª¤è¨Šæ¯æ ¼å¼åŒ–

**ç›¸é—œæ¨¡å‹**ï¼š
```python
class AgentChatModel(BaseModel):
    """èŠå¤©è«‹æ±‚è³‡æ–™æ¨¡å‹"""
    api_key: str
    message: str
    session_id: str
    ear_num_context: Optional[str] = None
    
    class Config:
        str_strip_whitespace = True
        min_anystr_length = 1
```

---

## âš™ï¸ é…ç½®æª”æ¡ˆ

### ğŸ“¦ å‰ç«¯é…ç½®

#### `/frontend/package.json`
**åŠŸèƒ½**ï¼šå‰ç«¯ä¾è³´ç®¡ç†å’Œè…³æœ¬å®šç¾©
```json
{
  "dependencies": {
    "vue": "^3.4.0",
    "element-plus": "^2.4.0",
    "@element-plus/icons-vue": "^2.3.0",
    "pinia": "^2.1.0",
    "axios": "^1.6.0"
  }
}
```

#### `/frontend/vite.config.js`
**åŠŸèƒ½**ï¼šå‰ç«¯å»ºæ§‹é…ç½®
```javascript
export default defineConfig({
  plugins: [vue()],
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:5000',
        changeOrigin: true
      }
    }
  }
});
```

### ğŸ å¾Œç«¯é…ç½®

#### `/backend/requirements.txt`
**åŠŸèƒ½**ï¼šPython ä¾è³´åˆ—è¡¨
```
Flask==2.3.3
Flask-Login==0.6.3
Flask-SQLAlchemy==3.0.5
Pydantic==2.4.2
requests==2.31.0
markdown==3.5.1
```

#### `/backend/.env`
**åŠŸèƒ½**ï¼šç’°å¢ƒè®Šæ•¸é…ç½®
```bash
GOOGLE_API_KEY=your_gemini_api_key_here
MAX_CONTENT_LENGTH=10485760  # 10MB
SECRET_KEY=your_secret_key_here
```

---

## ğŸ§ª æ¸¬è©¦æª”æ¡ˆ

### ğŸ” å–®å…ƒæ¸¬è©¦

#### `/test_image_upload.py`
**åŠŸèƒ½**ï¼šåŸºæœ¬åŠŸèƒ½æ¸¬è©¦
```python
def test_base64_encoding():
    """æ¸¬è©¦åœ–ç‰‡ base64 ç·¨ç¢¼åŠŸèƒ½"""
    fake_image_data = b'\x89PNG\r\n\x1a\n...'
    encoded = base64.b64encode(fake_image_data).decode('utf-8')
    decoded = base64.b64decode(encoded)
    assert fake_image_data == decoded
```

#### `/frontend/src/stores/chat.test.js`
**åŠŸèƒ½**ï¼šå‰ç«¯ç‹€æ…‹ç®¡ç†æ¸¬è©¦
```javascript
describe('Chat Store - Image Upload', () => {
  test('should handle image data correctly', () => {
    const imageData = {
      file: new File(['test'], 'test.jpg', { type: 'image/jpeg' }),
      url: 'data:image/jpeg;base64,...',
      name: 'test.jpg'
    };
    expect(sendMessage('api_key', 'message', null, imageData)).toBeDefined();
  });
});
```

---

## ğŸ“š æ–‡æª”æª”æ¡ˆ

### ğŸ“– ä½¿ç”¨æŒ‡å—

#### `/docs/ç…§ç‰‡ä¸Šå‚³åŠŸèƒ½æŒ‡å—.md`
**åŠŸèƒ½**ï¼šå®Œæ•´çš„ä½¿ç”¨è€…æŒ‡å—å’ŒæŠ€è¡“èªªæ˜
- ğŸ¯ åŠŸèƒ½æ¦‚è¿°å’Œç‰¹è‰²
- ğŸ“± è©³ç´°ä½¿ç”¨æ­¥é©Ÿ
- ğŸ› ï¸ æŠ€è¡“å¯¦ä½œèªªæ˜
- ğŸ› æ•…éšœæ’é™¤æŒ‡å—
- ğŸ“Š æ•ˆèƒ½æœ€ä½³åŒ–å»ºè­°

#### `/docs/ç…§ç‰‡ä¸Šå‚³åŠŸèƒ½æŠ€è¡“æ–‡æª”.md`
**åŠŸèƒ½**ï¼šé–‹ç™¼è€…æŠ€è¡“æ–‡æª”
- ğŸ—ï¸ ç³»çµ±æ¶æ§‹åœ–
- ğŸ”„ è³‡æ–™æµç¨‹èªªæ˜
- ğŸ’» ç¨‹å¼ç¢¼ç¯„ä¾‹
- ğŸ§ª æ¸¬è©¦ç­–ç•¥
- ğŸš€ éƒ¨ç½²æŒ‡å—

---

## ğŸ”§ éƒ¨ç½²ç›¸é—œæª”æ¡ˆ

### ğŸ³ å®¹å™¨åŒ–é…ç½®

#### `/backend/Dockerfile`
**åŠŸèƒ½**ï¼šå¾Œç«¯ Docker é…ç½®
```dockerfile
FROM python:3.9-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY . .
CMD ["python", "run.py"]
```

#### `/frontend/Dockerfile`
**åŠŸèƒ½**ï¼šå‰ç«¯ Docker é…ç½®
```dockerfile
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build
```

#### `/docker-compose.yml`
**åŠŸèƒ½**ï¼šæ•´é«”æœå‹™ç·¨æ’
```yaml
services:
  backend:
    build: ./backend
    environment:
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
  frontend:
    build: ./frontend
    ports:
      - "3000:80"
```

---

## ğŸ“Š æª”æ¡ˆçµ±è¨ˆæ‘˜è¦

### ğŸ¯ åŠŸèƒ½åˆ†ä½ˆ
- **å‰ç«¯æª”æ¡ˆ**: 3 å€‹ä¸»è¦æª”æ¡ˆ
- **å¾Œç«¯æª”æ¡ˆ**: 4 å€‹ä¸»è¦æª”æ¡ˆ
- **é…ç½®æª”æ¡ˆ**: 6 å€‹é…ç½®æª”æ¡ˆ
- **æ¸¬è©¦æª”æ¡ˆ**: 2 å€‹æ¸¬è©¦æª”æ¡ˆ
- **æ–‡æª”æª”æ¡ˆ**: 3 å€‹èªªæ˜æ–‡æª”
- **éƒ¨ç½²æª”æ¡ˆ**: 3 å€‹éƒ¨ç½²é…ç½®

### ğŸ“ˆ ç¨‹å¼ç¢¼è¦æ¨¡
- **å‰ç«¯ç¨‹å¼ç¢¼**: ~500 è¡Œ (Vue + JavaScript)
- **å¾Œç«¯ç¨‹å¼ç¢¼**: ~300 è¡Œ (Python + Flask)
- **æ¸¬è©¦ç¨‹å¼ç¢¼**: ~100 è¡Œ
- **æ–‡æª”å…§å®¹**: ~2000 è¡Œ

### ğŸ”§ æŠ€è¡“æ£§
- **å‰ç«¯**: Vue.js 3, Element Plus, Pinia, Vite
- **å¾Œç«¯**: Flask, SQLAlchemy, Pydantic
- **API**: Google Gemini Vision API
- **è³‡æ–™åº«**: SQLite (é–‹ç™¼), PostgreSQL (ç”Ÿç”¢)
- **éƒ¨ç½²**: Docker, Docker Compose

---

## ğŸš€ å¿«é€Ÿå®šä½æŒ‡å—

### ğŸ› é™¤éŒ¯æ™‚æŸ¥çœ‹çš„æª”æ¡ˆ
1. `/frontend/src/views/ChatView.vue` - å‰ç«¯ UI å•é¡Œ
2. `/backend/app/api/agent.py` - å¾Œç«¯ API å•é¡Œ
3. `/frontend/src/api/index.js` - ç¶²è·¯è«‹æ±‚å•é¡Œ
4. `/backend/app/utils.py` - Gemini API å‘¼å«å•é¡Œ

### ğŸ”§ åŠŸèƒ½æ“´å±•æ™‚ä¿®æ”¹çš„æª”æ¡ˆ
1. `/frontend/src/stores/chat.js` - ç‹€æ…‹ç®¡ç†æ“´å±•
2. `/backend/app/schemas.py` - è³‡æ–™é©—è­‰æ“´å±•
3. `/backend/app/models.py` - è³‡æ–™åº«æ¨¡å‹æ“´å±•
4. `/docs/` - æ–‡æª”æ›´æ–°

### ğŸ“¦ éƒ¨ç½²æ™‚éœ€è¦çš„æª”æ¡ˆ
1. `/docker-compose.yml` - æœå‹™ç·¨æ’
2. `/backend/Dockerfile` - å¾Œç«¯å®¹å™¨
3. `/frontend/Dockerfile` - å‰ç«¯å®¹å™¨
4. `/.env` - ç’°å¢ƒè®Šæ•¸é…ç½®

---

*æª”æ¡ˆæ¸…å–®ç‰ˆæœ¬ï¼šv1.0.0*  
*æœ€å¾Œæ›´æ–°ï¼š2025å¹´8æœˆ1æ—¥*
